# Deadlocks (교착상태)

| <img width="432" alt="Screen Shot 2022-09-11 at 4 46 27 PM" src="https://user-images.githubusercontent.com/59877415/189517415-04fef6ae-810c-4c41-bd70-9a132243ef9c.png"> | 데드락이란?<br /><br />- 시스템 자원에 대한 요구가 뒤엉킨 상태<br />- 둘 이상의 프로세스가 서로가 가진 자원을 필요로 하며<br />무한 대기에 빠지는 상황 |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

---

### 데드락은 언제 발생할까?

- 조건1) Mutual exclusion (상호 배타)

  - 자원 공유가 불가능하다.
  - 예를 들어 특정 자원의 인스턴스가 2개이면 최대 2개의 프로세스만 해당 자원을 사용할 수 있다.

- 조건2) Hold and wait (보유 및 대기)

- 조건3) No Preemption (비선점)

  - 다른 프로세스가 보유중인 자원을 뺐어올 수 없다.

- 조건4) Circular wait (환형 대기)

  - 자원 할당도 상에 원이 만들어져야 한다.
  - 자원 할당도
    - 자원은 네모로, 자원의 인스턴스는 점으로, 프로세스는 원으로, 자원의 할당은 화살표로 표시된다.

  - | <img width="250" alt="Screen Shot 2022-09-11 at 5 07 05 PM" src="https://user-images.githubusercontent.com/59877415/189518018-844cd147-bad4-4248-b19a-d3b0d781910a.png"> | <img width="275" alt="Screen Shot 2022-09-11 at 5 07 17 PM" src="https://user-images.githubusercontent.com/59877415/189518021-a612908e-73d2-4e91-b884-1316e0a6e5c8.png"> |
    | ------------------------------------------------------------ | ------------------------------------------------------------ |
    | 환형대기 (O) Deadlock (O)                                    | 환형 대기 (O) Deadlock (X)                                   |

→ 위의 조건들은 데드락의 필요조건으로, **4가지 조건이 모두 만족**될 경우 데드락이 일어날 **수도** 있다.

---

### 데드락은 어떻게 처리할까?

1. 교착 상태 방지 : 데드락의 발생 조건을 막는다.
2. 교착 상태 회피 : 프로세스의 자원 요청을 신중하게 승인한다.
3. 교착 상태 검출 및 복구
4. 교착 상태 무시

---

### 교착 상태 방지

-  교착 상태의 4가지 필요 조건 중 한 가지 이상을 불만족시키면 된다.

1. 상호 배타 방지

   - 자원을 공유 가능하게 한다.

   - 원천적으로 불가능한 경우가 대부분이다.

     → CPU, 메모리, 디스크, 프린트 모두 불가능하고 read only 파일 정도만 가능하다.

2. 보유 및 대기 방지

   - 프로세스가 동시에 모든 자원을 잡거나 순차적으로 자원을 잡는 경우 다 잡지 못하면 소유한 자원을 놓는다.
   - 자원 활용률이 저하되거나 기아(starvation) 문제가 발생할 수 있다.

3. 비선점 방지

   - 자원을 선점 가능하게 한다.

   - 원천적으로 불가능한 경우가 대부분이다.

     → 프린터 선점을 가능하게 하면 난리가 날 것이다. CPU context switching을 강제로 할 수는 있겠으나 부작용이 있을 것이다.

4. 환형 대기 방지

   | <img width="332" alt="Screen Shot 2022-09-11 at 5 20 46 PM" src="https://user-images.githubusercontent.com/59877415/189518314-5c52a6b1-7bb5-4795-8db6-5c559d84f4e4.png"> | - 자원에 번호를 부여하여 오름차순으로 자원을 요청하게 한다. <br />-  위의 그림은 식사하는 철학자 예시로 교착상태에 빠진 상황인데,<br />환형 대기 방지를 하면 R0를 기점으로 원이 끊어지게 된다.<br />- 자원 활용율이 저하되는 문제가 있다. |
   | ------------------------------------------------------------ | ------------------------------------------------------------ |

- 1번과 3번 방법은 현실성이 떨어지고 2번과 4번 방법은 그나마 사용가능하다.

---

### 교착상태 회피

| <img width="266" alt="Screen Shot 2022-09-11 at 5 30 42 PM" src="https://user-images.githubusercontent.com/59877415/189518654-8c661af2-423a-4b24-97f9-9f0bd06bdf57.png"> | - 교착 상태를 자원 요청에 대한 잘못된 승인으로<br />보는 관점에서의 해결책이다.<br /><br />- Process(Application)가 Resource(Hardware)를<br />필요로 할 때 OS가 자원 요청을 잘못 승인한 경우 |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

- 이를 해결하려면 OS가 **안전한 할당**을 해주면 된다.
- 아래는 자원이 12개인 상황에서의 예시이다. Current needs는 시작할 때의 자원 필요량, Max needs는 해당 작업을 끝낼 때의 자원 필요량이다.

| <img width="700" alt="Screen Shot 2022-09-11 at 5 37 25 PM" src="https://user-images.githubusercontent.com/59877415/189518871-94538df4-4228-41a9-800f-5b1bfc5fe7bc.png"> | 안전한 할당의 예시<br /><br />모두 실행 -> P1 종료 -> P0 종료 -> P2 종료 |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| <img width="703" alt="Screen Shot 2022-09-11 at 5 37 36 PM" src="https://user-images.githubusercontent.com/59877415/189518879-13925bc2-b53d-4e5c-8fce-116b0fd3ef93.png"> | 불안전한 할당의 예시<br /><br />모두 실행 -> P1 종료 -> 교착 상태 |

- 대출 전문 은행의 문제 해결 방식과 비슷하다. (Banker's Algorithm)

---

### 
